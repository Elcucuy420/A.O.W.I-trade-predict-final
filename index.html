<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>A.O.W.I Actions HUD â€” 24h</title>
<style>
  body{background:#0b0f19;color:#e5e7eb;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  header{display:flex;justify-content:space-between;align-items:center;padding:16px 18px;border-bottom:1px solid #1f2b3f;background:#0d162b}
  .wrap{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:14px}
  .card{background:#0f172a;border:1px solid #1f2b3f;border-radius:14px;padding:12px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input,select,button{background:#0b1020;color:#e5e7eb;border:1px solid #23314a;border-radius:10px;padding:10px}
  button{background:#22d3ee;border:none;color:#00131a;font-weight:800;cursor:pointer}
  .mut{color:#9aa5b6;font-size:12px}
  .hud{display:grid;gap:12px}
  .ticket{display:grid;grid-template-columns: 1fr auto;gap:12px;padding:14px;border:1px solid #24324a;border-radius:12px;background:#0b1223}
  .pill{padding:4px 10px;border-radius:999px;font-weight:700;font-size:12px;border:1px solid #26324a}
  .p-break{background:#052412;color:#9ff3b1;border-color:#0f3c25}
  .p-mean{background:#2d1b06;color:#ffd89a;border-color:#5b3b0b}
  .p-situ{background:#0b1930;color:#9fd0ff;border-color:#274a78}
  .pricebox{display:grid;grid-template-columns:repeat(4, minmax(120px,1fr));gap:10px}
  .cell{background:#0b1324;border:1px solid #22304a;border-radius:10px;padding:8px}
  .k{font-size:12px;color:#9fb0cf}.v{font-weight:800;font-size:16px}
  .buy{color:#22c55e}.sell{color:#ef4444}
  #canvas{display:none}
</style>
</head>
<body>
<header><b>ðŸ§  A.O.W.I â€” Actions HUD</b><small id="state" class="mut">Awaiting screenshotsâ€¦</small></header>
<div class="wrap">
  <div class="card">
    <div class="toolbar">
      <span class="mut">ðŸ“¥ Screenshots</span>
      <input id="file" type="file" accept="image/*" multiple>
      <select id="axisSide"><option value="right">Axis: Right</option><option value="left">Axis: Left</option></select>
      <select id="posture"><option value="std">Posture: Standard</option><option value="aggr">Aggressive</option><option value="safe">Conservative</option></select>
      <button id="analyze">Analyze</button>
    </div>
    <small id="status" class="mut">Outputs **next 24h** windows with **Entry / SL / TP1 / TP2**. OCR + indicators run in the background.</small>
  </div>

  <div id="hud" class="hud"></div>
  <canvas id="canvas" width="1200" height="800"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
(function(){
  const $=s=>document.querySelector(s);
  const file=$('#file'), analyzeBtn=$('#analyze'), hud=$('#hud'), statusEl=$('#status'), stateEl=$('#state');
  const axisSideEl=$('#axisSide'), postureEl=$('#posture');
  const canvas=$('#canvas'), ctx=canvas.getContext('2d');
  let images=[];

  // ----------------- helpers
  function drawFit(img){const sc=Math.min(canvas.width/img.width,canvas.height/img.height);
    const w=img.width*sc,h=img.height*sc,x=(canvas.width-w)/2,y=(canvas.height-h)/2;
    ctx.clearRect(0,0,canvas.width,canvas.height);ctx.fillStyle='#0b0f17';ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img,x,y,w,h);return {x,y,w,h,scale:sc};}
  async function loadFiles(fs){images=[];for(const f of fs){const u=URL.createObjectURL(f);const im=new Image();im.src=u;await im.decode();images.push({img:im,u});}statusEl.textContent=`Loaded ${images.length} image(s).`}
  file.addEventListener('change',e=>loadFiles(e.target.files));

  function avg(x0,y0,w,h){const d=ctx.getImageData(x0,y0,w,h).data;let r=0,g=0,b=0,n=0;for(let i=0;i<d.length;i+=4){r+=d[i];g+=d[i+1];b+=d[i+2];n++;}return[r/n,g/n,b/n]}
  function dist(a,b){return Math.hypot(a[0]-b[0],a[1]-b[1],a[2]-b[2])}
  function sma(a,p){const o=[];let s=0;for(let i=0;i<a.length;i++){s+=a[i];if(i>=p)s-=a[i-p];o.push(i>=p-1?s/p:a[i]);}return o}
  function ema(a,p){const k=2/(p+1);const o=[];let e=a[0];for(let i=0;i<a.length;i++){e=i?(a[i]*k+e*(1-k)):a[0];o.push(e);}return o}
  function rsi(cl,p=14){let g=[],l=[];for(let i=1;i<cl.length;i++){const d=cl[i]-cl[i-1];g.push(Math.max(0,d));l.push(Math.max(0,-d));}
    g=sma(g,p);l=sma(l,p);const o=[50];for(let i=1;i<cl.length;i++){const rs=(g[i-1]||1e-6)/(l[i-1]||1e-6);o.push(100-100/(1+rs));}return o}
  function macd(cl,a=12,b=26,s=9){const e1=ema(cl,a),e2=ema(cl,b);const m=e1.map((v,i)=>v-(e2[i]||v));const sig=ema(m,s);return {hist:m.map((v,i)=>v-(sig[i]||0))}}
  function boll(cl,p=20,k=2){const m=sma(cl,p),o=[];for(let i=0;i<cl.length;i++){const a=Math.max(0,i-p+1),sl=cl.slice(a,i+1),u=m[i],sd=Math.sqrt(sl.reduce((s,v)=>s+(v-u)*(v-u),0)/Math.max(1,sl.length));o.push({bw:(k*sd)/(u||1)});}return o}
  function linreg(x,y){const n=x.length,sx=x.reduce((a,b)=>a+b,0),sy=y.reduce((a,b)=>a+b,0),sxx=x.reduce((a,b)=>a+b*b,0),sxy=x.reduce((a,b,i)=>a+b*y[i],0),d=n*sxx-sx*sx||1e-6;return{m:(n*sxy-sx*sy)/d,b:(sy-((n*sxy-sx*sy)/d)*sx)/n}}
  function parseNums(t){const r=/(?:\d{3,4}(?:\.\d+)?)/g;const a=[];let m;while((m=r.exec(t))!==null){a.push(parseFloat(m[0]));}return a}

  function sampleStrip(rect){const {x,y,w,h}=rect,step=Math.max(2,Math.floor(w/240));const H=[],L=[],C=[],bg=avg(x,y,w,Math.min(20,h));for(let xi=x;xi<x+w;xi+=step){
      let hi=null,lo=null;for(let yi=y;yi<y+h;yi++){const p=ctx.getImageData(xi,yi,1,1).data;if(dist([p[0],p[1],p[2]],bg)>30){hi=yi;break}}
      for(let yi=y+h-1;yi>=y;yi--){const p=ctx.getImageData(xi,yi,1,1).data;if(dist([p[0],p[1],p[2]],bg)>30){lo=yi;break}}
      if(hi==null||lo==null) continue; const closeY=lo-Math.min(5,lo-y);
      H.push(hi);L.push(lo);C.push(closeY);
    }return{H,L,C}}
  async function ocrMap(rect){
    const tmp=document.createElement('canvas');tmp.width=rect.w;tmp.height=rect.h;
    tmp.getContext('2d').drawImage(canvas,rect.x,rect.y,rect.w,rect.h,0,0,rect.w,rect.h);
    const {data:{text}}=await Tesseract.recognize(tmp.toDataURL('image/png'),'eng');
    const nums=parseNums(text).filter(v=>v>100&&v<10000); if(nums.length<2) return null;
    const ys=[],xs=[];for(let i=0;i<nums.length;i++){xs.push(nums[i]);ys.push(rect.y+(i/(nums.length-1))*rect.h)}
    const {m,b}=linreg(ys,xs); return {m,b};
  }

  async function measure(img){
    const fit=drawFit(img); const stripW=Math.round(fit.w*0.12);
    const sx=(axisSideEl.value==='right')? fit.x+fit.w-stripW : fit.x;
    const region={x:sx,y:fit.y,w:stripW,h:fit.h};
    // OCR absolute map
    let lastPrice=0;
    try{const map=await ocrMap(region); if(map){
      const s=sampleStrip(region);
      const closes=s.C.map(py=> map.m*py + map.b);
      lastPrice=closes.at(-1);
      const highs=s.H.map(py=> map.m*py + map.b), lows=s.L.map(py=> map.m*py + map.b);
      const atr=(function atrHL(H,L,C,p=14){const tr=[];for(let i=0;i<H.length;i++){if(i===0){tr.push(H[i]-L[i]);}else{tr.push(Math.max(H[i]-L[i],Math.abs(H[i]-C[i-1]),Math.abs(L[i]-C[i-1])));}}return sma(tr,p).at(-1) || 2})()
        (highs,lows,closes);
      const rsi=rsi(closes,14).at(-1)||50;
      const macdh=macd(closes).hist.at(-1)||0;
      const bb=boll(closes).at(-1).bw||0.02;
      // slopeâ†’trend
      const X=[...Array(closes.length).keys()],{m}=linreg(X,closes); const trend=m>0?'Up':(m<0?'Down':'Sideways');
      return {atr,lastPrice,rsi,macdh,bb,trend,ocr:true};
    }}catch(e){}
    // Fallback (relative only)
    const s=sampleStrip(region), sc=100/(s.C.at(-1)||100);
    const cl=s.C.map(v=>v*sc), hi=s.H.map(v=>v*sc), lo=s.L.map(v=>v*sc);
    const atrRel=sma(hi.map((v,i)=>Math.max(hi[i]-lo[i],Math.abs(hi[i]-(cl[i-1]||cl[i])),Math.abs(lo[i]-(cl[i-1]||cl[i]))),14).at(-1)||2;
    const rsiRel=rsi(cl,14).at(-1)||50, macdhRel=macd(cl).hist.at(-1)||0, bbRel=boll(cl).at(-1).bw||0.02;
    return {atr:Math.max(0.5,Math.min(12,(atrRel/2)*4)),lastPrice:0,rsi:rsiRel,macdh:macdhRel,bb:bbRel,trend:(()=>{const X=[...Array(cl.length).keys()],{m}=linreg(X,cl);return m>0?'Up':(m<0?'Down':'Sideways')})(),ocr:false};
  }

  function confluence(M,posture){
    const W=posture==='aggr'?{s:2,m:1}:posture==='safe'?{s:1,m:2}:{s:1.5,m:1.5};
    let s=60; if(M.bb<0.015) s+=8*W.m;
    if(M.trend==='Up' && M.rsi>52 && M.macdh>0) s+=10*W.s;
    if(M.trend==='Down' && M.rsi<48 && M.macdh<0) s+=10*W.s;
    if(M.rsi>55) s+=6*W.m; if(M.rsi<45) s+=6*W.m;
    return Math.max(0,Math.min(100,Math.round(s)));
  }

  function windows24h(M){
    const now=new Date();
    const tzLocal=Intl.DateTimeFormat().resolvedOptions().timeZone||'Europe/Oslo';
    function at(tz,hm){const [H,MM]=hm.split(':').map(Number); const base=new Date(now.toLocaleString('en-US',{timeZone:tz}));
      base.setHours(H,MM,0,0); return new Date(base.toLocaleString('en-US',{timeZone:tzLocal})); }
    const defs=[
      {label:'London Open',  tz:'Europe/London',     start:'08:00', dur:120, bias:'Breakout'},
      {label:'US 08:30 Data',tz:'America/New_York',  start:'08:30', dur: 60, bias:'Breakout'},
      {label:'COMEX Open',   tz:'America/New_York',  start:'08:20', dur: 25, bias:'Breakout'},
      {label:'NYSE Open',    tz:'America/New_York',  start:'09:30', dur: 60, bias:'Breakout'},
      {label:'LBMA AM Fix',  tz:'Europe/London',     start:'10:30', dur: 20, bias:'Situational'},
      {label:'LBMA PM Fix',  tz:'Europe/London',     start:'15:00', dur: 25, bias:'Situational'},
      {label:'London Close', tz:'Europe/London',     start:'16:00', dur: 60, bias:'Mean-reversion'},
      {label:'Asia Pulse',   tz:'Asia/Tokyo',        start:'09:00', dur: 60, bias:'Mean-reversion'}
    ];
    const baseScore=confluence(M, postureEl.value);
    return defs.map(d=>{
      const s=at(d.tz,d.start); const e=new Date(s.getTime()+d.dur*60000);
      const score=Math.max(0,Math.min(100,Math.round(baseScore + (d.bias==='Breakout'?+6:(d.bias==='Mean-reversion'?-2:0)))));
      const P=Math.max(5,Math.min(95,Math.round(30+(score-50)*0.7)));
      let dir='Wait'; if(d.bias==='Breakout'&&M.trend==='Up'&&M.rsi>52&&M.macdh>0) dir='LONG';
      if(d.bias==='Breakout'&&M.trend==='Down'&&M.rsi<48&&M.macdh<0) dir='SHORT';
      if(d.bias==='Mean-reversion') dir='Fade';
      const ref=M.lastPrice||0, atr=M.atr||2;
      const entry = dir==='LONG' ? (ref+0.25*atr) : dir==='SHORT' ? (ref-0.25*atr) : ref;
      const sl    = dir==='LONG' ? (entry-0.8*atr) : dir==='SHORT' ? (entry+0.8*atr) : ref;
      const tp1   = dir==='LONG' ? (entry+1.2*atr) : dir==='SHORT' ? (entry-1.2*atr) : ref;
      const tp2   = dir==='LONG' ? (entry+2.0*atr) : dir==='SHORT' ? (entry-2.0*atr) : ref;
      return {label:d.label,start:s,end:e,bias:d.bias,dir,score,P,entry,sl,tp1,tp2,hasPrice:ref>0};
    }).sort((a,b)=>a.start-b.start); // list chronologically (today)
  }

  function fmt(v){return v>0? v.toFixed(2) : 'âˆ¼';}
  function render(list){
    hud.innerHTML='';
    list.forEach(w=>{
      const el=document.createElement('div'); el.className='ticket';
      const pc=w.bias==='Breakout'?'p-break':(w.bias==='Mean-reversion'?'p-mean':'p-situ');
      const dir=w.dir==='LONG'?'buy':(w.dir==='SHORT'?'sell':'');
      el.innerHTML=`
        <div class="pill ${pc}">${w.bias}</div>
        <div style="text-align:right"><b class="${dir}">${w.dir}</b><br><span class="mut">Score ${w.score} â€¢ Pâ‰ˆ${w.P}%</span></div>
        <div style="grid-column:1 / -1" class="mut"><b>${w.label}</b> â€¢ ${w.start.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}â€“${w.end.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div>
        <div style="grid-column:1 / -1" class="pricebox">
          <div class="cell"><div class="k">Entry</div><div class="v">${fmt(w.entry)}</div></div>
          <div class="cell"><div class="k">Stop</div><div class="v">${fmt(w.sl)}</div></div>
          <div class="cell"><div class="k">TP1</div><div class="v">${fmt(w.tp1)}</div></div>
          <div class="cell"><div class="k">TP2</div><div class="v">${fmt(w.tp2)}</div></div>
        </div>`;
      hud.appendChild(el);
    });
  }

  // -------- main
  analyzeBtn.addEventListener('click', async()=>{
    if(images.length===0){statusEl.textContent='Select screenshots first.';return;}
    stateEl.textContent='Analyzingâ€¦';
    let M=null; for(const it of images){ M=await measure(it.img); }   // use the most recent image
    const list=windows24h(M);
    render(list);
    stateEl.textContent='Signals ready.';
    statusEl.textContent=`${M.ocr?'OCR price map ok':'Lite mode (no absolute price)'} â€¢ Trend ${M.trend} â€¢ ATRâ‰ˆ$${M.atr?.toFixed?.(2)||M.atr} â€¢ RSIâ‰ˆ${M.rsi.toFixed(0)} â€¢ MACDâ‰ˆ${M.macdh.toFixed(2)} â€¢ BBâ‰ˆ${(M.bb*100).toFixed(1)}%`;
  });
})();
</script>
</body></html>
